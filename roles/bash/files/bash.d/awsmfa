# vim: set filetype=sh :

function awsmfa() {
  local account=$1

  if [[ "$account" != "personal" ]] && [[ "$account" != "oslprod" ]]; then
    echo "usage: awsmfa <personal | oslprod>"
    return 1
  fi

  if [[ "$account" == "personal" ]]; then
    OP_ITEM_UUID="sry6trqusc464dqlztdkvkozhq"
  elif [[ "$account" == "oslprod" ]]; then
    OP_ITEM_UUID="lqrqw4wcf3oky46iirjubbcivu"
  fi

  OP_ACCT=$(op get account > /dev/null 2>&1)
  if [[ $? != 0 ]]; then
    eval $(op signin)
  fi

  OP_ACCT=$(op get account > /dev/null 2>&1)
  if [[ $? != 0 ]]; then
    echo "Sign-in failed, maybe try again"
    return 1
  fi

  local AWS_MFA_SESSION_DURATION="28800"
  local AWS_INFO=$(op get item "$OP_ITEM_UUID")
  local AWS_LOGIN=$(echo $AWS_INFO | jq -r '.details.fields[] | select(.name == "username") | .value')
  local AWS_ACCOUNT_NUMER=$(echo $AWS_INFO | jq -r '.details.sections[] | select(.title == "Credentials") | .fields[] | select(.t == "AWS_ACCOUNT_NUMBER") | .v')
  local AWS_ACCESS_KEY_ID=$(echo $AWS_INFO | jq -r '.details.sections[] | select(.title == "Credentials") | .fields[] | select(.t == "AWS_ACCESS_KEY_ID") | .v')
  local AWS_SECRET_ACCESS_KEY=$(echo $AWS_INFO | jq -r '.details.sections[] | select(.title == "Credentials") | .fields[] | select(.t == "AWS_SECRET_ACCESS_KEY") | .v')

  output=$(AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} aws sts get-session-token --duration-seconds ${AWS_MFA_SESSION_DURATION})

  TEMP_AWS_ACCESS_KEY_ID=$(echo $output | jq -r '.Credentials.AccessKeyId')
  TEMP_AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r '.Credentials.SecretAccessKey')
  TEMP_AWS_SESSION_TOKEN=$(echo $output | jq -r '.Credentials.SessionToken')

  aws configure set aws_access_key_id ${TEMP_AWS_ACCESS_KEY_ID} --profile $account
  aws configure set aws_secret_access_key ${TEMP_AWS_SECRET_ACCESS_KEY} --profile $account
  aws configure set aws_session_token ${TEMP_AWS_SESSION_TOKEN} --profile $account

  echo "AWS temporary credentials successfully set for profile \"$account\" (Username: $AWS_LOGIN, Account: $AWS_ACCOUNT_NUMER)"
}
